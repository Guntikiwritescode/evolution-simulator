(()=>{var e={4770:e=>{"use strict";e.exports=require("crypto")},2918:(e,t,n)=>{var r=n(2288),i=n(594),a=n(5009),o=n(3498),s=n(7992),u=n(6348),l=n(6551);l.alea=r,l.xor128=i,l.xorwow=a,l.xorshift7=o,l.xor4096=s,l.tychei=u,e.exports=l},2288:function(e,t,n){var r;!function(e,i,a){function o(e){var t,n=this,r=(t=4022871197,function(e){e=String(e);for(var n=0;n<e.length;n++){var r=.02519603282416938*(t+=e.charCodeAt(n));t=r>>>0,r-=t,r*=t,t=r>>>0,r-=t,t+=4294967296*r}return(t>>>0)*23283064365386963e-26});n.next=function(){var e=2091639*n.s0+23283064365386963e-26*n.c;return n.s0=n.s1,n.s1=n.s2,n.s2=e-(n.c=0|e)},n.c=1,n.s0=r(" "),n.s1=r(" "),n.s2=r(" "),n.s0-=r(e),n.s0<0&&(n.s0+=1),n.s1-=r(e),n.s1<0&&(n.s1+=1),n.s2-=r(e),n.s2<0&&(n.s2+=1)}function s(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function u(e,t){var n=new o(e),r=t&&t.state,i=n.next;return i.int32=function(){return 4294967296*n.next()|0},i.double=function(){return i()+(2097152*i()|0)*11102230246251565e-32},i.quick=i,r&&("object"==typeof r&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.alea=u}(0,e=n.nmd(e),n.amdD)},6348:function(e,t,n){var r;!function(e,i,a){function o(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,r=t.d,i=t.a;return e=e<<25^e>>>7^n,n=n-r|0,r=r<<24^r>>>8^i,i=i-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-r|0,t.d=r<<16^n>>>16^i,t.a=i-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var r=0;r<n.length+20;r++)t.b^=0|n.charCodeAt(r),t.next()}function s(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function u(e,t){var n=new o(e),r=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152;while(0===e);return e},i.int32=n.next,i.quick=i,r&&("object"==typeof r&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.tychei=u}(0,e=n.nmd(e),n.amdD)},594:function(e,t,n){var r;!function(e,i,a){function o(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),t.next()}function s(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function u(e,t){var n=new o(e),r=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152;while(0===e);return e},i.int32=n.next,i.quick=i,r&&("object"==typeof r&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.xor128=u}(0,e=n.nmd(e),n.amdD)},7992:function(e,t,n){var r;!function(e,i,a){function o(e){var t=this;t.next=function(){var e,n,r=t.w,i=t.X,a=t.i;return t.w=r=r+1640531527|0,n=i[a+34&127],e=i[a=a+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=i[a]=n^e,t.i=a,n+(r^r>>>16)|0},function(e,t){var n,r,i,a,o,s=[],u=128;for(t===(0|t)?(r=t,t=null):(t+="\0",r=0,u=Math.max(u,t.length)),i=0,a=-32;a<u;++a)t&&(r^=t.charCodeAt((a+32)%t.length)),0===a&&(o=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,a>=0&&(o=o+1640531527|0,i=0==(n=s[127&a]^=r+o)?i+1:0);for(i>=128&&(s[127&(t&&t.length||0)]=-1),i=127,a=512;a>0;--a)r=s[i+34&127],n=s[i=i+1&127],r^=r<<13,n^=n<<17,r^=r>>>15,n^=n>>>12,s[i]=r^n;e.w=o,e.X=s,e.i=i}(t,e)}function s(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function u(e,t){null==e&&(e=+new Date);var n=new o(e),r=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152;while(0===e);return e},i.int32=n.next,i.quick=i,r&&(r.X&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.xor4096=u}(0,e=n.nmd(e),n.amdD)},3498:function(e,t,n){var r;!function(e,i,a){function o(e){var t=this;t.next=function(){var e,n,r=t.x,i=t.i;return e=r[i],e^=e>>>7,n=e^e<<24^((e=r[i+1&7])^e>>>10)^((e=r[i+3&7])^e>>>3)^((e=r[i+4&7])^e<<7),e=r[i+7&7],e^=e<<13,n^=e^e<<9,r[i]=n,t.i=i+1&7,n},function(e,t){var n,r=[];if(t===(0|t))r[0]=t;else for(n=0,t=""+t;n<t.length;++n)r[7&n]=r[7&n]<<15^t.charCodeAt(n)+r[n+1&7]<<13;for(;r.length<8;)r.push(0);for(n=0;n<8&&0===r[n];++n);for(8==n?r[7]=-1:r[n],e.x=r,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function s(e,t){return t.x=e.x.slice(),t.i=e.i,t}function u(e,t){null==e&&(e=+new Date);var n=new o(e),r=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152;while(0===e);return e},i.int32=n.next,i.quick=i,r&&(r.x&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.xorshift7=u}(0,e=n.nmd(e),n.amdD)},5009:function(e,t,n){var r;!function(e,i,a){function o(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(e^e<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var r=0;r<n.length+64;r++)t.x^=0|n.charCodeAt(r),r==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function s(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function u(e,t){var n=new o(e),r=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/2097152;while(0===e);return e},i.int32=n.next,i.quick=i,r&&("object"==typeof r&&s(r,n),i.state=function(){return s(n,{})}),i}i&&i.exports?i.exports=u:n.amdD&&n.amdO?void 0!==(r=(function(){return u}).call(t,n,t,i))&&(i.exports=r):this.xorwow=u}(0,e=n.nmd(e),n.amdD)},6551:function(e,t,n){var r;!function(i,a,o){var s,u=o.pow(256,6),l=o.pow(2,52),c=2*l;function f(e,t,n){var r=[],f=p(function e(t,n){var r,i=[],a=typeof t;if(n&&"object"==a)for(r in t)try{i.push(e(t[r],n-1))}catch(e){}return i.length?i:"string"==a?t:t+"\0"}((t=!0==t?{entropy:!0}:t||{}).entropy?[e,g(a)]:null==e?function(){try{var e;return s&&(e=s.randomBytes)?e=e(256):(e=new Uint8Array(256),(i.crypto||i.msCrypto).getRandomValues(e)),g(e)}catch(e){var t=i.navigator,n=t&&t.plugins;return[+new Date,i,n,i.screen,g(a)]}}():e,3),r),v=new d(r),m=function(){for(var e=v.g(6),t=u,n=0;e<l;)e=(e+n)*256,t*=256,n=v.g(1);for(;e>=c;)e/=2,t/=2,n>>>=1;return(e+n)/t};return m.int32=function(){return 0|v.g(4)},m.quick=function(){return v.g(4)/4294967296},m.double=m,p(g(v.S),a),(t.pass||n||function(e,t,n,r){return(r&&(r.S&&h(r,v),e.state=function(){return h(v,{})}),n)?(o.random=e,t):e})(m,f,"global"in t?t.global:this==o,t.state)}function d(e){var t,n=e.length,r=this,i=0,a=r.i=r.j=0,o=r.S=[];for(n||(e=[n++]);i<256;)o[i]=i++;for(i=0;i<256;i++)o[i]=o[a=255&a+e[i%n]+(t=o[i])],o[a]=t;(r.g=function(e){for(var t,n=0,i=r.i,a=r.j,o=r.S;e--;)t=o[i=255&i+1],n=256*n+o[255&(o[i]=o[a=255&a+t])+(o[a]=t)];return r.i=i,r.j=a,n})(256)}function h(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function p(e,t){for(var n,r=e+"",i=0;i<r.length;)t[255&i]=255&(n^=19*t[255&i])+r.charCodeAt(i++);return g(t)}function g(e){return String.fromCharCode.apply(0,e)}if(p(o.random(),a),e.exports){e.exports=f;try{s=n(4770)}catch(e){}}else void 0!==(r=(function(){return f}).call(t,n,t,e))&&(e.exports=r)}("undefined"!=typeof self?self:this,[],Math)}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var a=t[r]={id:r,loaded:!1,exports:{}},o=!0;try{e[r].call(a.exports,a,a.exports,n),o=!1}finally{o&&delete t[r]}return a.loaded=!0,a.exports}n.amdD=function(){throw Error("define cannot be used indirect")},n.amdO={},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{"use strict";var e,t,r=n(2918),i=n.n(r);class a{constructor(e){this.prng=i()(String(e))}random(e=0,t=1){return e+this.prng()*(t-e)}gaussian(e,t){let n=this.prng(),r=this.prng();for(;0===n;)n=this.prng();return e+Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*r)*t}shuffle(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(this.prng()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}}var o=n(4770),s=n.n(o);let u={randomUUID:s().randomUUID},l=new Uint8Array(256),c=l.length,f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));let d=function(e,t,n){if(u.randomUUID&&!t&&!e)return u.randomUUID();let r=(e=e||{}).random||(e.rng||function(){return c>l.length-16&&(s().randomFillSync(l),c=0),l.slice(c,c+=16)})();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return f[e[t+0]]+f[e[t+1]]+f[e[t+2]]+f[e[t+3]]+"-"+f[e[t+4]]+f[e[t+5]]+"-"+f[e[t+6]]+f[e[t+7]]+"-"+f[e[t+8]]+f[e[t+9]]+"-"+f[e[t+10]]+f[e[t+11]]+f[e[t+12]]+f[e[t+13]]+f[e[t+14]]+f[e[t+15]]}(r)};function h(e,t){return[e[0]-t[0],e[1]-t[1]]}function p(e,t){return[e[0]+t[0],e[1]+t[1]]}function g(e,t){return[e[0]*t,e[1]*t]}function v(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function m(e){let t=v(e);return 0===t?[1,0]:[e[0]/t,e[1]/t]}function x(e,t){return e[0]*t[0]+e[1]*t[1]}function y(e,t,n){let r=m(h(t,e)),i=h(e,n),a=h(t,n),o=x(i,r);return o*x(a,r)>0?null:g(r,-o)}function w(e,t,n){let r=y(e,t,n);if(null===r)return null;let i=h(n,e);return v(h(r,i))}function R(e,t){let n=Math.cos(t),r=Math.sin(t);return[e[0]*n-e[1]*r,e[0]*r+e[1]*n]}function S(e,t,n){return Math.max(Number.MIN_VALUE,e.gaussian(t,n))}function b(e,t,n){return Math.max(0,e.gaussian(t,n))}function E(e){return{id:d(),speed:{value:1,variance:1},size:{value:1,variance:1},senseRange:{value:1,variance:1},reach:{value:1,variance:1},fleeDistance:{value:1,variance:1},lifeSpan:{value:1,variance:1},energy:500,energyConsumed:0,age:0,pos:[e[0],e[1]],homePos:[e[0],e[1]],foodsEaten:[],movementHistory:[[e[0],e[1]]],state:"active",objective:null}}function M(e,t,n,r,i,a,o,s=500){return{id:d(),speed:t,size:n,senseRange:r,reach:i,fleeDistance:a,lifeSpan:o,energy:s,energyConsumed:0,age:0,pos:[e[0],e[1]],homePos:[e[0],e[1]],foodsEaten:[],movementHistory:[[e[0],e[1]]],state:"active",objective:null}}function C(e){return{...E([e.homePos[0],e.homePos[1]]),id:e.id,speed:{...e.speed},size:{...e.size},senseRange:{...e.senseRange},reach:{...e.reach},fleeDistance:{...e.fleeDistance},lifeSpan:{...e.lifeSpan},energy:e.energy,age:e.age+1}}function P(e){return e.size.value}function z(e){return e.speed.value*e.size.value/10}function D(e){return e.senseRange.value}function A(e){return Math.max(e.reach.value,P(e)/4)}function I(e){let t=P(e),n=z(e);return 1e-4*(t*t*t*n*n+D(e))}function j(e){return Math.max(0,e.energy-e.energyConsumed)}function F(e){let t=e.movementHistory.length;return t<=1?null:e.movementHistory[t-2]}function O(e){let t=null;if(e.objective){var n;let r=h(e.objective.pos,e.pos);(1===(n=e.objective.intensity)||3===n||5===n||7===n)&&(r=g(r,-1)),0!==v(r)&&(t=r)}if(!t){let n=F(e);n&&(t=h(e.pos,n)),t&&0!==v(t)||(t=[1,0])}return m(t)}function T(e,t){return v(h(t,e.pos))<=D(e)}function N(e,t){if(v(h(t,e.pos))<=A(e))return!0;let n=F(e);if(!n)return!1;let r=w(e.pos,n,t);return null!==r&&r<=A(e)}function B(e,t){if(!e.objective||t.intensity>e.objective.intensity){e.objective=t;return}if(t.intensity===e.objective.intensity){let n=v(h(e.pos,e.objective.pos));v(h(e.pos,t.pos))<n&&(e.objective=t)}}function G(e,t,n){e.foodsEaten.push({step:t,id:n.getEdibleId(),type:n.getType()})}function V(e){e.state="dead"}function L(e){return"dead"!==e.state}function U(e){return"active"===e.state}function k(e){return"available"!==e.status}(function(e){e[e.MinorCraving=0]="MinorCraving",e[e.MinorAversion=1]="MinorAversion",e[e.ModerateCraving=2]="ModerateCraving",e[e.ModerateAversion=3]="ModerateAversion",e[e.MajorCraving=4]="MajorCraving",e[e.MajorAversion=5]="MajorAversion",e[e.VitalCraving=6]="VitalCraving",e[e.VitalAversion=7]="VitalAversion"})(e||(e={})),function(e){e.REPRODUCE="REPRODUCE",e.INIT="INIT",e.PRE="PRE",e.ORIENT="ORIENT",e.MOVE="MOVE",e.ACT="ACT",e.POST="POST",e.FINAL="FINAL"}(t||(t={}));class q{constructor(e,n,r){this.steps=1,this.creatures=n,this.food=r.map(e=>(function(e){return{id:d(),position:[e[0],e[1]],status:"available",getEdibleId(){return this.id},getType:()=>"food_ball"}})(e)),this.runPhase(t.INIT,e),this.stepToCompletion(e),this.runPhase(t.FINAL,e)}hasLivingCreatures(){return this.creatures.some(e=>L(e))}hasActiveCreatures(){return this.creatures.some(e=>U(e))}getAvailableFood(){return this.food.filter(e=>!k(e))}markFoodEaten(e){let t=this.food.findIndex(t=>t.id===e.id);-1!==t&&(this.food[t].status={eaten:this.steps})}stepToCompletion(e){for(;this.hasActiveCreatures();)this.step(e)}runPhase(e,t){for(let n of t.behaviours)n.apply(e,this,t)}shuffleCreatures(e){e.rng.shuffle(this.creatures)}step(e){this.steps>=1e6||(this.shuffleCreatures(e),this.runPhase(t.PRE,e),this.runPhase(t.ORIENT,e),this.runPhase(t.MOVE,e),this.runPhase(t.ACT,e),this.runPhase(t.POST,e),this.steps+=1)}}class ${apply(e,n,r){if(e===t.PRE)for(let e of n.creatures)L(e)&&(e.objective=null)}}class H{static willReproduce(e){return e.foodsEaten.length>1}reproduce(e,t){let n=[];for(let i of e)if(L(i)){if(H.willReproduce(i)){var r;n.push((r=t.rng,{...E([i.homePos[0],i.homePos[1]]),speed:{value:S(r,i.speed.value,i.speed.variance),variance:i.speed.variance},size:{value:S(r,i.size.value,i.size.variance),variance:i.size.variance},senseRange:{value:b(r,i.senseRange.value,i.senseRange.variance),variance:i.senseRange.variance},reach:{value:S(r,i.reach.value,i.reach.variance),variance:i.reach.variance},fleeDistance:{value:b(r,i.fleeDistance.value,i.fleeDistance.variance),variance:i.fleeDistance.variance},lifeSpan:{value:S(r,i.lifeSpan.value,i.lifeSpan.variance),variance:i.lifeSpan.variance},energy:i.energy}))}n.push(C(i))}return n}}class X{reproduce(e,t){let n=[];for(let t of e)if(L(t)){if(t.foodsEaten.length>1){let e=C(t);e.age=0,n.push(e)}n.push(C(t))}return n}}class _{constructor(e,t,n){this.stage=e,this.rng=new a(t),this.foodPerGeneration=n,this.generations=[],this.behaviours=[new $],this.reproductionBehaviour=new H}addBehaviour(e){this.behaviours.push(e)}setReproductionBehaviour(e){this.reproductionBehaviour=e}getRandomLocation(){return this.stage.getRandomLocation(this.rng)}getRandomFloat(e,t){return this.rng.random(e,t)}getRandomGaussian(e,t){return this.rng.gaussian(e,t)}generateFood(){let e=this.generations.length,t=Math.round(this.foodPerGeneration.get(e)),n=[];for(let e=0;e<t;e++)n.push(this.getRandomLocation());return n}execReproduction(e){return this.reproductionBehaviour.reproduce(e,this)}run(e,t){let n=new q(this,e,this.generateFood()),r=n.hasLivingCreatures();for(let e=1;e<t&&r;e++){let e=this.execReproduction(n.creatures);this.generations.push(n),r=(n=new q(this,e,this.generateFood())).hasLivingCreatures()}this.generations.push(n)}runSingleGeneration(e){return new q(this,e,this.generateFood())}}class W{constructor(e){this.size=e}getEdges(){let e=this.size;return[[[0,0],[e,0]],[[e,0],[e,e]],[[e,e],[0,e]],[[0,e],[0,0]]]}canMoveTo(e){return e[0]>=0&&e[1]>=0&&e[0]<=this.size&&e[1]<=this.size}getCenter(){return[.5*this.size,.5*this.size]}getRandomLocation(e){return[e.random(0,this.size),e.random(0,this.size)]}getNearestEdgePoint(e){let t=.5*this.size,n=e[0]>t?this.size:0,r=e[1]>t?this.size:0;return Math.abs(n-e[0])<Math.abs(r-e[1])?[n,e[1]]:[e[0],r]}constrainWithin(e){return[Math.max(0,Math.min(this.size,e[0])),Math.max(0,Math.min(this.size,e[1]))]}}class J{constructor(e){this.pts=[...e]}get(e){var t,n,r;let i=this.pts.length;if(0===i)return 0;let a=this.pts[0][0],o=this.pts[i-1][0];if(e<a)return this.pts[0][1];if(e>=o)return this.pts[i-1][1];let s=0;for(let t=0;t<i&&(s=t,!(e<this.pts[t][0]));t++);let u=this.pts[s-1][0],l=this.pts[s][0];return u===l?this.pts[s][1]:(t=this.pts[s-1][1],n=this.pts[s][1],t*(1-(r=(e-u)/(l-u)))+n*r)}}class K{apply(e,n,r){if(e===t.MOVE)for(let e of n.creatures){if(!U(e))continue;let t=p(e.pos,g(O(e),z(e)));!function(e,t){e.pos=[t[0],t[1]],e.movementHistory.push([t[0],t[1]]);let n=I(e);e.energyConsumed+=n,0>=j(e)&&(e.state="dead")}(e,r.stage.constrainWithin(t))}}}class Q{apply(n,r,i){if(n===t.ORIENT)for(let t of r.creatures){if(!U(t))continue;let n=i.getRandomFloat(-Math.PI/4,Math.PI/4),r=R(O(t),n),a=p(t.pos,r);i.stage.canMoveTo(a)?B(t,{pos:a,intensity:e.MinorCraving,reason:"wandering"}):B(t,{pos:i.stage.getCenter(),intensity:e.MinorCraving,reason:"wandering"})}}}class Y{constructor(e=.8){this.sizeRatio=e}forPredPreyPair(e,t){for(let n=1;n<e.length;n++)if(U(e[n]))for(let r=0;r<n;r++){let i,a;let o=e[r],s=e[n];U(o)&&U(s)&&(P(o)>P(s)?(i=o,a=s):(i=s,a=o),U(i)&&U(a)&&(P(i)*this.sizeRatio<P(a)||t(i,a)))}}apply(n,r,i){if(n===t.ORIENT){let t=new Map;this.forPredPreyPair(r.creatures,(n,r)=>{var a;if(T(r,a=n.pos)&&v(h(r.pos,a))<r.fleeDistance.value){let t=i.getRandomFloat(-Math.PI/4,Math.PI/4),a=h(n.pos,r.pos),o=p(r.pos,R(a,t));B(r,{pos:o,intensity:e.VitalAversion,reason:"running away"})}if(!T(n,r.pos))return;let o=t.get(n.id);if(void 0!==o&&o<=z(r))return;t.set(n.id,z(r));let s=0===n.foodsEaten.length?e.VitalCraving:1===n.foodsEaten.length?e.ModerateCraving:e.MinorCraving;B(n,{pos:r.pos,intensity:s,reason:"see prey"})})}if(n===t.ACT){let e=r.steps;this.forPredPreyPair(r.creatures,(t,n)=>{N(t,n.pos)&&(G(t,e,{getEdibleId:()=>n.id,getType:()=>"creature"}),V(n))})}}}function Z(e){return U(e)&&e.foodsEaten.length<2}function ee(e,t){let n=null,r=1/0;for(let i of t){let t=v(h(i.position,e.pos));!isNaN(t)&&t<r&&(r=t,n=i)}return n}class et{apply(n,r,i){if(n===t.ORIENT){let t=r.getAvailableFood();for(let n of r.creatures){if(!Z(n))continue;let r=ee(n,t);if(r&&T(n,r.position)){let t=0===n.foodsEaten.length?e.VitalCraving:1===n.foodsEaten.length?e.ModerateCraving:e.MinorCraving;B(n,{pos:r.position,intensity:t,reason:"see food"})}}}if(n===t.ACT){let e=r.getAvailableFood();for(let t of r.creatures){if(!Z(t))continue;let n=ee(t,e);n&&!k(n)&&N(t,n.position)&&(G(t,r.steps,n),r.markFoodEaten(n),e=e.filter(e=>e.id!==n.id))}}}}class en{apply(n,r,i){if(n===t.ORIENT)for(let t of r.creatures){if(!U(t))continue;let n=function(t){let n=t.foodsEaten.length;return 0===n?null:n>1?{pos:t.homePos,intensity:e.MajorCraving,reason:"satisfied"}:function(t){let n;let r=v(h(t.homePos,t.pos)),i=I(t),a=z(t);if(0===a)return null;let o=i>0?j(t)/i-r/a:1/0;return null===(n=o>10?null:o>5?e.MinorCraving:o>0?e.MajorCraving:e.VitalCraving)?null:{pos:t.homePos,intensity:n,reason:"low energy"}}(t)}(t);n&&(B(t,n),N(t,t.homePos))&&(t.state="asleep")}}}class er{constructor(e=[]){this.disabledEdges=e}setHome(e,t){let n=t.stage.getEdges(),r=null,i=1/0;for(let t=0;t<n.length;t++){if(this.disabledEdges.includes(t))continue;let a=w(n[t][0],n[t][1],e.pos);null!==a&&a<i&&(i=a,r=n[t])}if(r){let t=y(r[0],r[1],e.pos);t&&(e.homePos=p(r[0],t))}else e.homePos=[Number.MAX_VALUE,0]}apply(e,n,r){if(e===t.PRE)for(let e of n.creatures)L(e)&&this.setHome(e,r)}}class ei{apply(e,n,r){if(e===t.INIT)for(let e of n.creatures)0===z(e)&&V(e);if(e===t.POST&&0===n.getAvailableFood().length)for(let e of n.creatures)U(e)&&e.foodsEaten.length<1&&V(e);if(e===t.FINAL)for(let e of n.creatures)L(e)&&e.foodsEaten.length<1&&V(e)}}function ea(e,t){if(e.length<=1)return 0;let n=0;for(let r of e){let e=r-t;n+=e*e}return n/(e.length-1)}let eo={trainingGenerations:50,transferGenerations:25,numRuns:30,populationSize:50,baseSeed:1e3,env1:{worldSize:500,foodPerGeneration:50,disabledEdges:[]},env2:{worldSize:800,foodPerGeneration:30,disabledEdges:[2,3]},gridSearchSpeedSize:[4,7,10,13,16,19],gridSearchSense:[5,10,15,20,25,30]},es={speed:10,size:10,senseRange:20,reach:1,fleeDistance:1e12,lifeSpan:1e4,variance:.5,energy:500};function eu(e,t,n){let r=new _(new W(e.worldSize),t,new J([[0,e.foodPerGeneration]]));return r.addBehaviour(new K),r.addBehaviour(new Q),r.addBehaviour(new Y(.8)),r.addBehaviour(new et),r.addBehaviour(new en),r.addBehaviour(new er(e.disabledEdges)),r.addBehaviour(new ei),n||r.setReproductionBehaviour(new X),r}function el(e,t,n){e.run(t,n);let r=[];for(let t=0;t<e.generations.length;t++)r.push(function(e,t){let n=e.creatures,r=n.length;if(0===r)return{generation:t,population:0,meanFoodEaten:0,survivalRate:0,reproductionRate:0,meanSpeed:0,meanSize:0,meanSenseRange:0,speedVariance:0,sizeVariance:0,senseRangeVariance:0,traitDiversity:0,creaturesEaten:0,computationSteps:e.steps};let i=0,a=0,o=0,s=0,u=0,l=0,c=0,f=[],d=[],h=[];for(let e of n){i+=e.foodsEaten.length,L(e)&&a++,H.willReproduce(e)&&o++;let t=e.speed.value,n=e.size.value,r=e.senseRange.value;for(let i of(s+=t,u+=n,l+=r,f.push(t),d.push(n),h.push(r),e.foodsEaten))"creature"===i.type&&c++}let p=s/r,g=u/r,v=l/r,m=ea(f,p),x=ea(d,g),y=ea(h,v),w=p>0?m/(p*p):0,R=g>0?x/(g*g):0,S=v>0?y/(v*v):0;return{generation:t,population:r,meanFoodEaten:i/r,survivalRate:a/r,reproductionRate:o/r,meanSpeed:p,meanSize:g,meanSenseRange:v,speedVariance:m,sizeVariance:x,senseRangeVariance:y,traitDiversity:w+R+S,creaturesEaten:c,computationSteps:e.steps}}(e.generations[t],t));return{metrics:r,finalCreatures:e.generations[e.generations.length-1].creatures.filter(e=>L(e))}}function ec(e,t){return t.execReproduction(e)}let ef=!1;self.onmessage=e=>{let t=e.data;if("cancel"===t.type){ef=!0;return}if("start"===t.type){ef=!1;let e=t.config??eo;try{let t=function(e=eo,t,n){let r=Date.now(),i=e.gridSearchSpeedSize.length**2*e.gridSearchSense.length,a=i+4*e.numRuns,o=0;function s(n,r,i,s){t&&t({phase:n,currentRun:r,totalRuns:e.numRuns,currentGeneration:i,totalGenerations:s,percentComplete:o/a*100})}let u=function(e,t,n,r,i,a,o){let s=e.length*t.length*n.length,u=[],l=null,c=0;for(let f of e)for(let e of t)for(let t of n){let n=function(e,t,n,r,i,a){let o=new W(r.worldSize),s=new _(o,`gs-eval-${a}-${e}-${t}-${n}`,new J([[0,r.foodPerGeneration]]));s.addBehaviour(new K),s.addBehaviour(new Q),s.addBehaviour(new Y(.8)),s.addBehaviour(new et),s.addBehaviour(new en),s.addBehaviour(new er(r.disabledEdges)),s.addBehaviour(new ei),s.setReproductionBehaviour(new X);let u=e=>({value:e,variance:0}),l=[];for(let r=0;r<i;r++){let r=s.getRandomLocation(),i=o.getNearestEdgePoint(r);l.push(M(i,u(e),u(t),u(n),u(es.reach),u(es.fleeDistance),u(es.lifeSpan),es.energy))}let c=s.runSingleGeneration(l),f=0,d=0;for(let e of c.creatures)f+=e.foodsEaten.length,e.foodsEaten.length>0&&d++;return{meanFood:c.creatures.length>0?f/c.creatures.length:0,survived:d}}(f,e,t,r,i,a),d={speed:f,size:e,senseRange:t,meanFoodEaten:n.meanFood,populationSurvived:n.survived};u.push(d),(!l||d.meanFoodEaten>l.meanFoodEaten)&&(l=d),c++,o&&o(c,s)}return{entries:u,bestSpeed:l?.speed??es.speed,bestSize:l?.size??es.size,bestSenseRange:l?.senseRange??es.senseRange,bestFitness:l?.meanFoodEaten??0}}(e.gridSearchSpeedSize,e.gridSearchSpeedSize,e.gridSearchSense,e.env1,e.populationSize,e.baseSeed,(e,t)=>{o=e,s("grid-search",0,e,t)});if(n?.())return null;o=i;let l=[];for(let t=0;t<e.numRuns;t++){if(n?.())return null;let r=e.baseSeed+t;s("et-training",t+1,0,e.trainingGenerations);let a=eu(e.env1,`et-train-${r}`,!0),u=function(e,t){let n=(e,t)=>({value:e,variance:t}),r=[],i=e.stage;for(let a=0;a<t;a++){let t=e.getRandomLocation(),a=i.getNearestEdgePoint(t);r.push(M(a,n(es.speed,es.variance),n(es.size,es.variance),n(es.senseRange,es.variance),n(es.reach,0),n(es.fleeDistance,0),n(es.lifeSpan,0),es.energy))}return r}(a,e.populationSize),c=el(a,u,e.trainingGenerations);o=i+4*t+1,s("et-transfer",t+1,0,e.transferGenerations);let f=eu(e.env2,`et-transfer-${r}`,!0),d=ec(c.finalCreatures,f),h=el(f,d,e.transferGenerations);l.push({seed:r,trainingMetrics:c.metrics,transferMetrics:h.metrics,finalCreatures:h.finalCreatures}),o=i+4*t+2}let c=[];for(let t=0;t<e.numRuns;t++){if(n?.())return null;let r=e.baseSeed+t;s("gs-training",t+1,0,e.trainingGenerations);let a=eu(e.env1,`gs-train-${r}`,!1),l=function(e,t,n,r,i){let a=e=>({value:e,variance:0}),o=[],s=e.stage;for(let u=0;u<t;u++){let t=e.getRandomLocation(),u=s.getNearestEdgePoint(t);o.push(M(u,a(n),a(r),a(i),a(es.reach),a(es.fleeDistance),a(es.lifeSpan),es.energy))}return o}(a,e.populationSize,u.bestSpeed,u.bestSize,u.bestSenseRange),f=el(a,l,e.trainingGenerations);o=i+2*e.numRuns+2*t+1,s("gs-transfer",t+1,0,e.transferGenerations);let d=eu(e.env2,`gs-transfer-${r}`,!1),h=ec(f.finalCreatures,d),p=el(d,h,e.transferGenerations);c.push({seed:r,trainingMetrics:f.metrics,transferMetrics:p.metrics,finalCreatures:p.finalCreatures}),o=i+2*e.numRuns+2*t+2}return{config:e,gridSearchResult:u,etRuns:l,gsRuns:c,wallClockMs:Date.now()-r}}(e,e=>{self.postMessage({type:"progress",data:e})},()=>ef);ef?self.postMessage({type:"cancelled"}):t&&self.postMessage({type:"complete",data:t})}catch(e){self.postMessage({type:"error",error:e instanceof Error?e.message:String(e)})}}}})(),module.exports={}})();